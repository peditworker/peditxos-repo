# ======================================================================================
# FILE 1 of 4: Build MAIN (Snapshot)
#
# This workflow builds ONLY the 'main' branch, but outputs to the 'snapshots'
# directory as required by opkg on routers.
#
# FIX: This version correctly uses "main" as the SDK tag for docker
#      and "snapshots" as the output directory name.
# ======================================================================================

name: 1. Build Main (Snapshot) Packages

on:
  workflow_dispatch:
  push:
    paths:
      - 'cur_ver.json'

jobs:
  # --- Stage 1: Generate Matrix ---
  generate_matrix_main:
    name: Generate Matrix for main (as snapshots)
    runs-on: ubuntu-latest
    outputs:
      sdks: ${{ steps.find_targets.outputs.sdks }}
    steps:
      - uses: actions/checkout@v4
        with: { repository: openwrt/openwrt, ref: 'main' }
      - id: find_targets
        run: |
          JSON='['; FIRST=1
          while read -r line; do
            [ -z "$line" ] && continue
            ARCH=$(echo "$line" | cut -d " " -f 1)
            [[ $FIRST -ne 1 ]] && JSON="$JSON"','
            # === FIX: Use "sdk_ref" for docker tag and "output_ref" for directory ===
            FIRST=0; JSON="$JSON"'{"arch":"'"$ARCH"'","sdk_ref":"main","output_ref":"snapshots","modern_toolchain":true}'
          done <<< $(perl ./scripts/dump-target-info.pl architectures 2>/dev/null)
          JSON="$JSON"']'
          echo "sdks=$JSON" >> "$GITHUB_OUTPUT"

  # --- Stage 2: Build Job ---
  build_main:
    name: Build for main (snapshots)
    needs: generate_matrix_main
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.generate_matrix_main.outputs.sdks) }}
    steps:
      - name: Free up disk space
        if: matrix.modern_toolchain == true
        run: |
          echo "Freeing up disk space..."
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo docker image prune -a -f
      - uses: actions/checkout@v4
      - run: sudo apt-get update && sudo apt-get install -y python3-pip jq && pip3 install nvchecker
      - id: ver
        run: |
          if [ ! -f cur_ver.json ]; then echo "{}" > cur_ver.json; fi
          jq -cr 'map("\(.name)=\(.newver)") | .[]' <<< $(nvcmp -c nvchecker.toml -aj) >> $GITHUB_OUTPUT
      - run: |
          mkdir -p package
          git clone --depth 1 https://github.com/peditx/luci-app-themeswitch.git package/luci-app-themeswitch
          git clone --depth 1 https://github.com/peditx/luci-theme-peditx.git package/luci-theme-peditx
          git clone --depth 1 https://github.com/peditx/luci-theme-carbonpx.git package/luci-theme-carbonpx
      - name: Override Go and Rust toolchains to latest
        if: matrix.modern_toolchain == true
        run: |
          echo "GOLANG_COMMIT=master" >> $GITHUB_ENV
          echo "RUST_COMMIT=master" >> $GITHUB_ENV
      - uses: moetayuko/gh-action-sdk@main
        env:
          # === FIX: Use sdk_ref for the docker image tag ===
          # ARCH is now e.g. aarch64_cortex-a53-main
          ARCH: ${{ matrix.arch }}-${{ matrix.sdk_ref }}
          EXTRA_FEEDS: |
            src-git|passwall_packages|https://github.com/xiaorouji/openwrt-passwall-packages^${{ steps.ver.outputs.packages }}
            src-git|passwall_luci|https://github.com/peditx/openwrt-passwall^${{ steps.ver.outputs.passwall }}
            src-git|passwall2|https://github.com/peditx/openwrt-passwall2^${{ steps.ver.outputs.passwall2 }}
          KEY_BUILD: ${{ secrets.SIGN_PRIV_KEY }}
          IGNORE_ERRORS: n m n
      - name: Organize packages for artifact upload
        run: |
          # === FIX: Use output_ref for the directory path ===
          # This now correctly creates dist/snapshots/aarch64_cortex-a53/
          mkdir -p "dist/${{ matrix.output_ref }}/${{ matrix.arch }}"
          find bin/packages/${{ matrix.arch }} -type f -name "*.ipk" -exec cp -t "dist/${{ matrix.output_ref }}/${{ matrix.arch }}/" {} +
          find bin/packages/${{ matrix.arch }} -maxdepth 1 -name "Packages*" -exec cp -t "dist/${{ matrix.output_ref }}/${{ matrix.arch }}/" {} +
          if [ -f "key-build.pub" ]; then cp key-build.pub "dist/"; fi
      - uses: actions/upload-artifact@v4
        with:
          # === FIX: Use output_ref for the artifact name ===
          name: packages-${{ matrix.output_ref }}-${{ matrix.arch }}
          path: dist
          retention-days: 5 # Keep artifact for 5 days for deploy job to find

