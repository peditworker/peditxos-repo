# ======================================================================================
# FILE 2 of 4: Build MODERN (23.05, 24.10)
#
# This workflow builds the modern, stable branches.
# FIX: Made disk cleanup step more AGGRESSIVE to prevent "No space left" errors.
# ======================================================================================

name: 2. Build Modern Packages (23.05, 24.10)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0' # Every Sunday at 00:00 UTC

jobs:
  # --- Stage 1: Generate Matrices (Parallel) ---
  generate_matrix_2410:
    name: Generate Matrix for 24.10
    runs-on: ubuntu-latest
    outputs:
      sdks: ${{ steps.find_targets.outputs.sdks }}
    steps:
      - uses: actions/checkout@v4
        with: { repository: openwrt/openwrt, ref: 'openwrt-24.10' }
      - id: find_targets
        run: |
          JSON='['; FIRST=1
          while read -r line; do
            [ -z "$line" ] && continue
            ARCH=$(echo "$line" | cut -d " " -f 1)
            [[ $FIRST -ne 1 ]] && JSON="$JSON"','
            FIRST=0; JSON="$JSON"'{"arch":"'"$ARCH"'","ref":"openwrt-24.10","modern_toolchain":true}'
          done <<< $(perl ./scripts/dump-target-info.pl architectures 2>/dev/null)
          JSON="$JSON"']'
          echo "sdks=$JSON" >> "$GITHUB_OUTPUT"

  generate_matrix_2305:
    name: Generate Matrix for 23.05
    runs-on: ubuntu-latest
    outputs:
      sdks: ${{ steps.find_targets.outputs.sdks }}
    steps:
      - uses: actions/checkout@v4
        with: { repository: openwrt/openwrt, ref: 'openwrt-23.05' }
      - id: find_targets
        run: |
          JSON='['; FIRST=1
          while read -r line; do
            [ -z "$line" ] && continue
            ARCH=$(echo "$line" | cut -d " " -f 1)
            [[ $FIRST -ne 1 ]] && JSON="$JSON"','
            FIRST=0; JSON="$JSON"'{"arch":"'"$ARCH"'","ref":"openwrt-23.05","modern_toolchain":true}'
          done <<< $(perl ./scripts/dump-target-info.pl architectures 2>/dev/null)
          JSON="$JSON"']'
          echo "sdks=$JSON" >> "$GITHUB_OUTPUT"

  # --- Stage 2: Build Job for 24.10 (Independent) ---
  build_2410:
    name: Build for 24.10
    needs: [generate_matrix_2410]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.generate_matrix_2410.outputs.sdks) }}
    steps:
      - name: Free up disk space (Aggressive)
        if: matrix.modern_toolchain == true
        run: |
          echo "Starting disk space cleanup..."
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY/CodeQL"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY/swift"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY/go"
          sudo rm -rf "/usr/local/lib/android"
          sudo rm -rf "/usr/local/share/powershell"
          sudo docker image prune -a -f
          echo "Cleanup finished."
          df -h
      - uses: actions/checkout@v4
      - run: sudo apt-get update && sudo apt-get install -y python3-pip jq && pip3 install nvchecker
      - id: ver
        run: |
          if [ ! -f cur_ver.json ]; then echo "{}" > cur_ver.json; fi
          jq -cr 'map("\(.name)=\(.newver)") | .[]' <<< $(nvcmp -c nvchecker.toml -aj) >> $GITHUB_OUTPUT
      - run: |
          mkdir -p package
          git clone --depth 1 https://github.com/peditx/luci-app-themeswitch.git package/luci-app-themeswitch
          git clone --depth 1 https://github.com/peditx/luci-theme-peditx.git package/luci-theme-peditx
          git clone --depth 1 https://github.com/peditx/luci-theme-carbonpx.git package/luci-theme-carbonpx
      - name: Override Go and Rust toolchains to latest
        if: matrix.modern_toolchain == true
        run: |
          echo "GOLANG_COMMIT=master" >> $GITHUB_ENV
          echo "RUST_COMMIT=master" >> $GITHUB_ENV
      - uses: moetayuko/gh-action-sdk@main
        env:
          ARCH: ${{ matrix.arch }}-${{ matrix.ref }}
          EXTRA_FEEDS: |
            src-git|passwall_packages|https://github.com/xiaorouji/openwrt-passwall-packages^${{ steps.ver.outputs.packages }}
            src-git|passwall_luci|https://github.com/peditx/openwrt-passwall^${{ steps.ver.outputs.passwall }}
            src-git|passwall2|https://github.com/peditx/openwrt-passwall2^${{ steps.ver.outputs.passwall2 }}
          KEY_BUILD: ${{ secrets.SIGN_PRIV_KEY }}
          IGNORE_ERRORS: n m n
      - name: Organize packages for artifact upload
        run: |
          mkdir -p "dist/${{ matrix.ref }}/${{ matrix.arch }}"
          find bin/packages/${{ matrix.arch }} -type f -name "*.ipk" -exec cp -t "dist/${{ matrix.ref }}/${{ matrix.arch }}/" {} +
          find bin/packages/${{ matrix.arch }} -maxdepth 1 -name "Packages*" -exec cp -t "dist/${{ matrix.ref }}/${{ matrix.arch }}/" {} +
          if [ -f "key-build.pub" ]; then cp key-build.pub "dist/"; fi
      - uses: actions/upload-artifact@v4
        with:
          name: packages-${{ matrix.ref }}-${{ matrix.arch }}
          path: dist
          retention-days: 5

  # --- Stage 2: Build Job for 23.05 (Independent) ---
  build_2305:
    name: Build for 23.05
    needs: [generate_matrix_2305]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.generate_matrix_2305.outputs.sdks) }}
    steps:
      - name: Free up disk space (Aggressive)
        if: matrix.modern_toolchain == true
        run: |
          echo "Starting disk space cleanup..."
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY/CodeQL"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY/swift"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY/go"
          sudo rm -rf "/usr/local/lib/android"
          sudo rm -rf "/usr/local/share/powershell"
          sudo docker image prune -a -f
          echo "Cleanup finished."
          df -h
      - uses: actions/checkout@v4
      - run: sudo apt-get update && sudo apt-get install -y python3-pip jq && pip3 install nvchecker
      - id: ver
        run: |
          if [ ! -f cur_ver.json ]; then echo "{}" > cur_ver.json; fi
          jq -cr 'map("\(.name)=\(.newver)") | .[]' <<< $(nvcmp -c nvchecker.toml -aj) >> $GITHUB_OUTPUT
      - run: |
          mkdir -p package
          git clone --depth 1 https://github.com/peditx/luci-app-themeswitch.git package/luci-app-themeswitch
          git clone --depth 1 https://github.com/peditx/luci-theme-peditx.git package/luci-theme-peditx
          git clone --depth 1 https://github.com/peditx/luci-theme-carbonpx.git package/luci-theme-carbonpx
      - name: Override Go and Rust toolchains to latest
        if: matrix.modern_toolchain == true
        run: |
          echo "GOLANG_COMMIT=master" >> $GITHUB_ENV
          echo "RUST_COMMIT=master" >> $GITHUB_ENV
      - uses: moetayuko/gh-action-sdk@main
        env:
          ARCH: ${{ matrix.arch }}-${{ matrix.ref }}
          EXTRA_FEEDS: |
            src-git|passwall_packages|https://github.com/xiaorouji/openwrt-passwall-packages^${{ steps.ver.outputs.packages }}
            src-git|passwall_luci|https://github.com/peditx/openwrt-passwall^${{ steps.ver.outputs.passwall }}
            src-git|passwall2|https://github.com/peditx/openwrt-passwall2^${{ steps.ver.outputs.passwall2 }}
          KEY_BUILD: ${{ secrets.SIGN_PRIV_KEY }}
          IGNORE_ERRORS: n m n
      - name: Organize packages for artifact upload
        run: |
          mkdir -p "dist/${{ matrix.ref }}/${{ matrix.arch }}"
          find bin/packages/${{ matrix.arch }} -type f -name "*.ipk" -exec cp -t "dist/${{ matrix.ref }}/${{ matrix.arch }}/" {} +
          find bin/packages/${{ matrix.arch }} -maxdepth 1 -name "Packages*" -exec cp -t "dist/${{ matrix.ref }}/${{ matrix.arch }}/" {} +
          if [ -f "key-build.pub" ]; then cp key-build.pub "dist/"; fi
      - uses: actions/upload-artifact@v4
        with:
          name: packages-${{ matrix.ref }}-${{ matrix.arch }}
          path: dist
          retention-days: 5

